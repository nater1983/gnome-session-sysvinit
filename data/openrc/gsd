#!/bin/sh
#
# SysVinit wrapper for GNOME Settings Daemon plugins
# Each symlink runs its corresponding plugin automatically

# Detect plugin name from symlink
RC_SVCNAME=$(basename "$0")

# User runtime directory for PID files
XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}
PIDFILE="${XDG_RUNTIME_DIR}/${RC_SVCNAME}.pid"

# Path to the actual plugin executable
DAEMON="/usr/libexec/${RC_SVCNAME}"

# Check if the plugin exists
if [ ! -x "$DAEMON" ]; then
    echo "Executable $DAEMON not found!"
    exit 1
fi

# If already running, do nothing
if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
    echo "${RC_SVCNAME} already running with PID $(cat "$PIDFILE")"
    exit 0
fi

# Ensure runtime dir exists
mkdir -p "$(dirname "$PIDFILE")"

# Start the plugin in the background
"$DAEMON" &
PID=$!
echo $PID > "$PIDFILE"
echo "${RC_SVCNAME} started with PID $PID"

exit 0
